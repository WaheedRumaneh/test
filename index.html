<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="./kyber-bundle.js"></script>
    <script type="text/javascript" src="./crypto-bundle.js"></script>
  </head>
  <body>
    <script type="module">
      // To generate a public and private key pair (pk, sk)
      const generateKeys = async () => {
        const [publicKey, privateKey] = await KeyGen1024();
        const returnedData = { publicKey, privateKey };
        window?.ReactNativeWebView?.postMessage(JSON.stringify(returnedData));
        return returnedData;
      };

      /* Eecrypt Start */
      // Step 1: Client encapsulates a symmetric key using the server's public key
      const encapsulateKey = async ({ publicKey }) => {
        const [encapsulation, symmetricKey] = await Encrypt1024(publicKey);
        const returnedData = { encapsulation, symmetricKey };
        window?.ReactNativeWebView?.postMessage(JSON.stringify(returnedData));
        return returnedData;
      };

      // Step 2: Client encrypts a message using AES-256-GCM with the symmetric key
      const encryptMessage = async ({ message, symmetricKey }) => {
        const { encryptedMessage, authTag, iv } = await window.CryptoEncrypt({
          message,
          key: symmetricKey,
        });
        const returnedData = { encryptedMessage, authTag, iv };
        window?.ReactNativeWebView?.postMessage(JSON.stringify(returnedData));
        return returnedData;
      };
      /* Eecrypt End */

      /* Decrypt Start */
      // Step 1: Server decapsulates the symmetric key using its private key
      const decapsulateKey = async ({ privateKey, encapsulation }) => {
        const symmetricKeyFromEncapsulation = await Decrypt1024(encapsulation, privateKey);
        const returnedData = { symmetricKeyFromEncapsulation };
        window?.ReactNativeWebView?.postMessage(JSON.stringify(returnedData));
        return returnedData;
      };

      // Step 2: Server decrypts the message using AES-256-GCM with the symmetric key
      const decryptMessage = async ({
        iv,
        authTag,
        encryptedMessage,
        symmetricKeyFromEncapsulation,
      }) => {
        const decryptedMessage = await window.CryptoDecrypt({
          iv,
          authTag,
          message: encryptedMessage,
          key: symmetricKeyFromEncapsulation,
        });
        const returnedData = { decryptedMessage };
        window?.ReactNativeWebView?.postMessage(JSON.stringify(returnedData));
        return returnedData;
      };
      /* Decrypt End */

      document.addEventListener('DOMContentLoaded', async () => {
        try {
          // The client sends the encapsulation, IV, auth tag, and encrypted message to the server
          const { privateKey, publicKey } = await generateKeys();
          console.log('privateKey:', privateKey);
          console.log('publicKey:', publicKey);
          console.log();

          const message = 'Hello World';
          const { encapsulation, symmetricKey } = await encapsulateKey({
            publicKey,
          });
          const { encryptedMessage, authTag, iv } = await encryptMessage({
            message,
            symmetricKey,
          });
          console.log('message:', message);
          console.log('encryptedMessage:', encryptedMessage);
          console.log('encapsulation:', encapsulation);
          console.log('authTag:', authTag);
          console.log('iv:', iv);
          console.log();

          const { symmetricKeyFromEncapsulation } = await decapsulateKey({
            privateKey,
            encapsulation,
          });
          const { decryptedMessage } = await decryptMessage({
            iv,
            authTag,
            encryptedMessage,
            symmetricKeyFromEncapsulation,
          });
          console.log('decryptedMessage:', decryptedMessage);
          console.log();

          window?.ReactNativeWebView?.postMessage(JSON.stringify(decryptedMessage));
          document.write('<p>DecryptedMessage: ' + decryptedMessage + '</p>');
          // Send the result back to React Native
          // window.ReactNativeWebView.postMessage(JSON.stringify({ sharedSecret, decryptedSecret }));
        } catch (error) {
          window?.ReactNativeWebView?.postMessage(JSON.stringify({ error: error.message }));
          document.write('<p>Error: ' + error.message + '</p>');
        }
      });
    </script>
  </body>
</html>
